<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | V-Wise</title>
<link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  animation: fadeIn 0.3s ease;
}

.modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background-color: var(--base-clr, #fff);
  border-radius: 12px;
  width: 90%;
  max-width: 700px;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.3s ease;
  display: flex;
  flex-direction: column;
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header {
  padding: 1.5rem 2rem;
  border-bottom: 1px solid var(--line-clr, #e0e0e0);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.modal-header h2 {
  margin: 0;
  font-size: 1.5rem;
  color: white;
}

.modal-close {
  background: none;
  border: none;
  font-size: 2rem;
  color: white;
  cursor: pointer;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.2);
}

.modal-body {
  padding: 2rem;
  overflow-y: auto;
  flex: 1;
}

.modal-footer {
  padding: 1rem 2rem;
  border-top: 1px solid var(--line-clr, #e0e0e0);
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
}

.detail-section {
  margin-bottom: 2rem;
}

.detail-section:last-child {
  margin-bottom: 0;
}

.detail-section h3 {
  color: #667eea;
  font-size: 1.1rem;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid #667eea;
}

.detail-row {
  display: grid;
  grid-template-columns: 150px 1fr;
  gap: 1rem;
  margin-bottom: 0.75rem;
  padding: 0.5rem 0;
}

.detail-label {
  font-weight: 600;
  color: var(--text-clr, #333);
}

.detail-value {
  color: var(--secondary-text-clr, #666);
}

.detail-value.platform {
  white-space: pre-wrap;
  line-height: 1.6;
  background: var(--hover-clr, #f5f5f5);
  padding: 1rem;
  border-radius: 8px;
  border-left: 4px solid #667eea;
}

.status-badge-modal {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
}

.status-badge-modal.approved {
  background: #d4edda;
  color: #155724;
}

.status-badge-modal.pending {
  background: #fff3cd;
  color: #856404;
}

.btn-info {
  background: #17a2b8;
  color: white;
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  transition: background 0.2s;
}

.btn-info:hover {
  background: #138496;
}

@media (max-width: 768px) {
  .modal-content {
    width: 95%;
    max-height: 95vh;
  }

  .detail-row {
    grid-template-columns: 1fr;
    gap: 0.25rem;
  }

  .modal-body {
    padding: 1.5rem;
  }
}
</style>

</head>
<body>
  <!-- Sidebar Navigation -->
  <nav id="sidebar">
    <ul>
      <li>
        <button id="toggle-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M440-240 200-480l240-240 56 56-183 184 183 184-56 56Zm264 0L464-480l240-240 56 56-183 184 183 184-56 56Z"/></svg>
        </button>
        <span class="logo">V-Wise Admin</span>
      </li>
      <li class="active">
        <a href="#" class="href" data-section="schedule">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Z"/></svg>
          <span>Voting Schedule</span>
        </a>
      </li>
      <li>
        <a href="#" class="href" data-section="approval">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M80-160v-112q0-33 17-62t47-44q51-26 115-44t141-18q30 0 58.5 3t55.5 9l-70 70q-11-2-21.5-2H400q-71 0-127.5 17T180-306q-9 5-14.5 14t-5.5 20v32h250l80 80H80Zm542 16L484-282l56-56 82 82 202-202 56 56-258 258ZM400-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm10 240Zm-10-320q33 0 56.5-23.5T480-640q0-33-23.5-56.5T400-720q-33 0-56.5 23.5T320-640q0 33 23.5 56.5T400-560Zm0-80Z"/></svg>
          <span>Candidate Approval</span>
        </a>
      </li>
      <li>
        <a href="#" class="href" data-section="candidates">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M0-240v-63q0-43 44-70t116-27q13 0 25 .5t23 2.5q-14 21-21 44t-7 48v65H0Zm240 0v-65q0-32 17.5-58.5T307-410q32-20 76.5-30t96.5-10q53 0 97.5 10t76.5 30q32 20 49 46.5t17 58.5v65H240Zm540 0v-65q0-26-6.5-49T754-397q11-2 22.5-2.5t23.5-.5q72 0 116 26.5t44 70.5v63H780Zm-455-80h311q-10-20-55.5-35T480-370q-55 0-100.5 15T325-320ZM160-440q-33 0-56.5-23.5T80-520q0-34 23.5-57t56.5-23q34 0 57 23t23 57q0 33-23 56.5T160-440Zm640 0q-33 0-56.5-23.5T720-520q0-34 23.5-57t56.5-23q34 0 57 23t23 57q0 33-23 56.5T800-440Zm-320-40q-50 0-85-35t-35-85q0-51 35-85.5t85-34.5q51 0 85.5 34.5T600-600q0 50-34.5 85T480-480Zm0-80q17 0 28.5-11.5T520-600q0-17-11.5-28.5T480-640q-17 0-28.5 11.5T440-600q0 17 11.5 28.5T480-560Zm1 240Zm-1-280Z"/></svg>
          <span>Add Candidates</span>
        </a>
      </li>
      <li>
        <a href="#" class="href" data-section="voters">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M720-400v-120H600v-80h120v-120h80v120h120v80H800v120h-80Zm-360-80q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Zm80-80h480v-32q0-11-5.5-20T580-306q-54-27-109-40.5T360-360q-56 0-111 13.5T140-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T440-640q0-33-23.5-56.5T360-720q-33 0-56.5 23.5T280-640q0 33 23.5 56.5T360-560Zm0-80Zm0 400Z"/></svg>
          <span>Add Voters</span>
        </a>
      </li>
      <li>
        <a href="#" class="href" data-section="results">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M280-280h80v-200h-80v200Zm160 0h80v-400h-80v400Zm160 0h80v-120h-80v120ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm0-560v560-560Z"/></svg>
          <span>View Results</span>
        </a>
      </li>
      <li>
        <a href="#" class="href" data-section="status">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="m105-233-65-47 200-320 120 140 160-260 109 163q-23 1-43.5 5.5T545-539l-22-33-152 247-121-141-145 233ZM863-40 738-165q-20 14-44.5 21t-50.5 7q-75 0-127.5-52.5T463-317q0-75 52.5-127.5T643-497q75 0 127.5 52.5T823-317q0 26-7 50.5T795-221L920-97l-57 57ZM643-217q42 0 71-29t29-71q0-42-29-71t-71-29q-42 0-71 29t-29 71q0 42 29 71t71 29Zm89-320q-19-8-39.5-13t-42.5-6l205-324 65 47-188 296Z"/></svg>
          <span>Voting Status</span>
        </a>
      </li>
    </ul>

    <div class="bottom-nav">
      <ul>
        <li>
          <button id="light-mode-btn">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M560-80q-82 0-155-31.5t-127.5-86Q223-252 191.5-325T160-480q0-83 31.5-155.5t86-127Q332-817 405-848.5T560-880q54 0 105 14t95 40q-91 53-145.5 143.5T560-480q0 112 54.5 202.5T760-134q-44 26-95 40T560-80Zm0-80h21q10 0 19-2-57-66-88.5-147.5T480-480q0-89 31.5-170.5T600-798q-9-2-19-2h-21q-133 0-226.5 93.5T240-480q0 133 93.5 226.5T560-160Zm-80-320Z"/></svg>
            <span>Night Mode</span>
            <div class="toggle-switch">
              <div class="slider"></div>
            </div>
          </button>
        </li>
        <li>
          <button id="logout-btn">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z"/></svg>
            <span>Logout</span>
          </button>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <main>
    
    <!-- Voting Schedule Section -->
    <section id="scheduleSection" class="content-section active">
      <h2>Voting Schedule</h2>
      
      <div class="card">
        <h3>Current Election Status</h3>
        <div class="status-badge" id="electionStatus">Loading...</div>
        
        <form id="scheduleForm" class="form">
          <div class="form-row">
            <div class="form-group">
              <label>Election Start Date & Time</label>
              <input type="datetime-local" id="startDate" required>
            </div>
            <div class="form-group">
              <label>Election End Date & Time</label>
              <input type="datetime-local" id="endDate" required>
            </div>
          </div>
          
          <div class="form-group">
            <label>Election Status</label>
            <select id="status" required>
              <option value="upcoming">Upcoming</option>
              <option value="active">Active</option>
              <option value="closed">Closed</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary">Save Schedule</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Candidate Approval Section -->
    <section id="approvalSection" class="content-section">
      <h2>Candidate Approval</h2>
      <p style="color: #757575; margin-bottom: 2rem;">Review and approve candidates running for Student Council positions</p>

      <div class="filter-tabs">
        <button class="tab-btn active" data-filter="all">All Candidates</button>
        <button class="tab-btn" data-filter="pending">Pending</button>
        <button class="tab-btn" data-filter="approved">Approved</button>
      </div>

      <div id="candidates-list" class="candidates-list">
        <!-- Candidates will be loaded here dynamically -->
      </div>
    </section>

    <!-- Candidate Details Modal -->
    <div id="candidateModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Candidate Details</h2>
          <button class="modal-close" onclick="closeCandidateModal()">&times;</button>
        </div>
        <div class="modal-body" id="candidateDetailsBody">
          <!-- Details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeCandidateModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- Add Candidates Section -->
    <section id="candidatesSection" class="content-section">
      <h2>Add Candidates</h2>
      
      <div class="card">
        <h3>Upload Candidates via Excel</h3>
        <p class="help-text">Excel file should contain: Partylist Name, Slogan, and all position candidates</p>
        
        <div class="upload-zone" onclick="document.getElementById('candidatesFile').click()">
          <input type="file" id="candidatesFile" accept=".xlsx,.xls" style="display:none">
          <div class="upload-icon">üìÑ</div>
          <p>Click to upload Excel file</p>
          <span class="file-hint">.xlsx or .xls</span>
        </div>

        <button class="btn-secondary" onclick="downloadCandidateTemplate()">
          üì• Download Template
        </button>

        <div id="candidatesPreview" class="preview-section" style="display:none">
          <h4>Preview</h4>
          <div id="candidatesPreviewContent"></div>
          <button class="btn-primary" onclick="uploadCandidates()">Upload Candidates</button>
        </div>
      </div>
    </section>

    <!-- Add Voters Section -->
    <section id="votersSection" class="content-section">
      <h2>Add Voters</h2>
      
      <div class="card">
        <h3>Upload Voters via Excel</h3>
        <p class="help-text">Excel file should contain: First Name, Middle Name, Last Name, Student ID, Email, Department, Year Level</p>
        
        <div class="upload-zone" onclick="document.getElementById('votersFile').click()">
          <input type="file" id="votersFile" accept=".xlsx,.xls" style="display:none">
          <div class="upload-icon">üìÑ</div>
          <p>Click to upload Excel file</p>
          <span class="file-hint">.xlsx or .xls</span>
        </div>

        <button class="btn-secondary" onclick="downloadVoterTemplate()">
          üì• Download Template
        </button>

        <div id="votersPreview" class="preview-section" style="display:none">
          <h4>Preview</h4>
          <div id="votersPreviewContent"></div>
          <button class="btn-primary" onclick="uploadVoters()">Upload Voters</button>
        </div>
      </div>
    </section>

    <!-- View Results Section -->
    <section id="resultsSection" class="content-section">
      <h2>Election Results</h2>
      
      <div class="card">
        <div class="results-header">
          <h3>Current Standings</h3>
          <button class="btn-secondary" onclick="loadResults()">üîÑ Refresh</button>
        </div>
        
        <div id="resultsContainer">
          <p class="loading">Loading results...</p>
        </div>
      </div>
    </section>

    <!-- Voting Status Section -->
    <section id="statusSection" class="content-section">
      <h2>Voting Status</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Voters</div>
          <div class="stat-value" id="totalVoters">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Votes Cast</div>
          <div class="stat-value" id="votesCast">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Turnout</div>
          <div class="stat-value" id="turnout">0%</div>
        </div>
      </div>

      <div class="card">
        <h3>Votes by Position</h3>
        <div id="positionBreakdown">
          <p class="loading">Loading...</p>
        </div>
      </div>
    </section>

  </main>

<script src="./sidebar.js"></script>
  <script>
    const API_URL = 'http://localhost:5000/api';
    let candidatesData = [];
    let votersData = [];
    let allCandidates = [];

    // Initialize
    window.onload = function() {
      loadSchedule();
      loadResults();
      loadVotingStatus();
      loadCandidatesForApproval();
      setupNavigation();
      setupFileHandlers();
      setupApprovalTabs();
    };

    // Navigation
    function setupNavigation() {
      document.querySelectorAll('.href').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const section = item.dataset.section;
          
          document.querySelectorAll('nav li').forEach(m => m.classList.remove('active'));
          item.parentElement.classList.add('active');
          
          document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
          document.getElementById(section + 'Section').classList.add('active');
        });
      });
    }

    // =====================
    // CANDIDATE APPROVAL
    // =====================
    
    function setupApprovalTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          const filter = this.dataset.filter;
          filterCandidates(filter);
        });
      });
    }

    async function loadCandidatesForApproval() {
      try {
        console.log('Loading candidates from /get-pending-candidates...');
        const response = await fetch('/get-pending-candidates');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        allCandidates = await response.json();
        console.log('Loaded candidates:', allCandidates);
        
        if (!allCandidates || allCandidates.length === 0) {
          console.warn('No candidates found in database');
        }
        
        filterCandidates('all');
        
      } catch (error) {
        console.error('Error loading candidates:', error);
        document.getElementById('candidates-list').innerHTML = 
          `<div class="card"><p class="error" style="color: red; padding: 2rem; text-align: center;">
            Failed to load candidates: ${error.message}<br>
            <small>Check browser console and Flask server logs for details</small>
          </p></div>`;
      }
    }

    function filterCandidates(filter) {
      let filtered = allCandidates;
      
      if (filter === 'pending') {
        filtered = allCandidates.filter(c => c.approved === 0 || c.approved === null);
      } else if (filter === 'approved') {
        filtered = allCandidates.filter(c => c.approved === 1);
      }
      
      renderCandidates(filtered);
    }

    function renderCandidates(candidates) {
      const container = document.getElementById('candidates-list');
      
      if (!container) return;
      
      if (candidates.length === 0) {
        container.innerHTML = '<div class="card"><p style="text-align: center; padding: 2rem; color: #757575;">No candidates found.</p></div>';
        return;
      }
      
      container.innerHTML = candidates.map(candidate => `
        <div class="candidate-item ${candidate.approved === 1 ? 'approved' : 'pending'}">
          <div class="candidate-details">
            <h3>${candidate.full_name || candidate.first_name + ' ' + candidate.last_name}</h3>
            <div class="candidate-meta">
              <span class="badge position-badge">Position: ${candidate.position}</span>
              <span class="badge party-badge">${candidate.party || candidate.affiliation_type}</span>
              <span class="badge">${candidate.college} - ${candidate.year_level}</span>
            </div>
            <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
              <strong>Student ID:</strong> ${candidate.student_id}<br>
              <strong>Email:</strong> ${candidate.email}<br>
              <strong>Platform:</strong> ${candidate.platform ? candidate.platform.substring(0, 150) + '...' : 'N/A'}
            </p>
            <p class="applied-date">Applied: ${new Date(candidate.created_at).toLocaleDateString()}</p>
          </div>
          
          <div class="candidate-status">
            ${candidate.approved === 1 
              ? '<span class="status-approved">‚úì Approved</span>' 
              : '<span class="status-pending">Pending</span>'
            }
          </div>
          
          <div class="candidate-actions">
            <button class="btn-info" onclick="viewCandidateDetails(${candidate.id})" title="View Full Details">
              <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Z"/></svg>
              View Details
            </button>
            ${candidate.approved !== 1 
              ? `<button class="btn-approve" onclick="approveCandidate(${candidate.id})">
                  <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/></svg>
                  Approve
                 </button>`
              : `<button class="btn-reject" onclick="rejectCandidate(${candidate.id})">
                  <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
                  Revoke
                 </button>`
            }
            <button class="btn-delete" onclick="deleteCandidate(${candidate.id})">
              <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
              Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    async function approveCandidate(id) {
      if (!confirm('Are you sure you want to approve this candidate?')) return;
      
      try {
        const response = await fetch(`/approve-candidate/${id}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('‚úÖ Candidate approved successfully!');
          loadCandidatesForApproval();
        } else {
          alert('‚ùå ' + (data.error || 'Failed to approve candidate'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while approving the candidate');
      }
    }

    async function rejectCandidate(id) {
      if (!confirm('Are you sure you want to revoke approval for this candidate?')) return;
      
      try {
        const response = await fetch(`/reject-candidate/${id}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('‚úÖ Candidate approval revoked!');
          loadCandidatesForApproval();
        } else {
          alert('‚ùå ' + (data.error || 'Failed to revoke approval'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
      }
    }

    async function deleteCandidate(id) {
      if (!confirm('‚ö†Ô∏è Are you sure you want to DELETE this candidate? This action cannot be undone!')) return;
      
      try {
        const response = await fetch(`/delete-candidate/${id}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('‚úÖ Candidate deleted successfully!');
          loadCandidatesForApproval();
        } else {
          alert('‚ùå ' + (data.error || 'Failed to delete candidate'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while deleting the candidate');
      }
    }

    // View Candidate Details in Modal
    function viewCandidateDetails(candidateId) {
      const candidate = allCandidates.find(c => c.id === candidateId);
      
      if (!candidate) {
        alert('Candidate not found');
        return;
      }

      const modal = document.getElementById('candidateModal');
      const modalBody = document.getElementById('candidateDetailsBody');
      
      // Format position name
      const positionNames = {
        '1': 'President',
        '2': 'Vice President',
        '3': 'Secretary',
        '4': 'Assistant Secretary',
        '5': 'Treasurer',
        '6': 'Auditor',
        '7': 'PIO (Public Information Officer)',
        '8': 'COE Representative',
        '9': 'CBAA Representative',
        '10': 'CTE Representative',
        '11': 'CCS Representative',
        '12': 'CCJE Representative',
        '13': 'CIT Representative',
        '14': 'CAS Representative',
        '15': 'CHMT Representative'
      };

      const positionName = positionNames[candidate.position] || candidate.position;
      
      modalBody.innerHTML = `
        <div class="detail-section">
          <h3>Personal Information</h3>
          <div class="detail-row">
            <div class="detail-label">Full Name:</div>
            <div class="detail-value">${candidate.full_name || candidate.first_name + ' ' + candidate.last_name}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Student ID:</div>
            <div class="detail-value">${candidate.student_id}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Email:</div>
            <div class="detail-value">${candidate.email}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">College:</div>
            <div class="detail-value">${candidate.college}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Year Level:</div>
            <div class="detail-value">${candidate.year_level}</div>
          </div>
        </div>

        <div class="detail-section">
          <h3>Candidacy Information</h3>
          <div class="detail-row">
            <div class="detail-label">Position:</div>
            <div class="detail-value">${positionName}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Affiliation:</div>
            <div class="detail-value">${candidate.party || candidate.affiliation_type}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Application Date:</div>
            <div class="detail-value">${new Date(candidate.created_at).toLocaleString()}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Status:</div>
            <div class="detail-value">
              <span class="status-badge-modal ${candidate.approved === 1 ? 'approved' : 'pending'}">
                ${candidate.approved === 1 ? '‚úì Approved' : 'Pending Approval'}
              </span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>Platform / Advocacy</h3>
          <div class="detail-value platform">${candidate.platform || 'No platform provided'}</div>
        </div>
      `;

      modal.classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    // Close Modal
    function closeCandidateModal() {
      const modal = document.getElementById('candidateModal');
      modal.classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('candidateModal');
      if (e.target === modal) {
        closeCandidateModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeCandidateModal();
      }
    });

    // =====================
    // REST OF THE CODE (Schedule, Voters, etc.)
    // =====================

    // Load Schedule
    async function loadSchedule() {
      try {
        const response = await fetch(`${API_URL}/election/status`);
        const data = await response.json();

        document.getElementById('startDate').value = formatDateForInput(data.election_start_date);
        document.getElementById('endDate').value = formatDateForInput(data.election_end_date);
        document.getElementById('status').value = data.election_status || 'upcoming';

        const statusBadge = document.getElementById('electionStatus');
        statusBadge.textContent = data.election_status.toUpperCase();
        statusBadge.className = 'status-badge ' + data.election_status;
      } catch (error) {
        console.error('Error loading schedule:', error);
      }
    }

    // Save Schedule
    document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const scheduleData = {
        election_start_date: document.getElementById('startDate').value,
        election_end_date: document.getElementById('endDate').value,
        election_status: document.getElementById('status').value
      };

      try {
        const response = await fetch(`${API_URL}/admin/election/settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(scheduleData)
        });

        if (response.ok) {
          alert('‚úÖ Schedule saved successfully!');
          loadSchedule();
        } else {
          alert('‚ùå Failed to save schedule');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Connection error');
      }
    });

    // File Handlers
    function setupFileHandlers() {
      document.getElementById('candidatesFile').addEventListener('change', handleCandidatesFile);
      document.getElementById('votersFile').addEventListener('change', handleVotersFile);
    }

    function handleCandidatesFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        candidatesData = XLSX.utils.sheet_to_json(sheet);

        displayCandidatesPreview(candidatesData);
      };
      reader.readAsArrayBuffer(file);
    }

    function displayCandidatesPreview(data) {
      const preview = document.getElementById('candidatesPreview');
      const content = document.getElementById('candidatesPreviewContent');
      
      content.innerHTML = `
        <p><strong>${data.length} partylist(s) found</strong></p>
        <div class="preview-list">
          ${data.map(p => `
            <div class="preview-item">
              <strong>${p['Name of Partylist']}</strong>
              <p>"${p['Slogan']}"</p>
            </div>
          `).join('')}
        </div>
      `;
      
      preview.style.display = 'block';
    }

    async function uploadCandidates() {
      if (!candidatesData.length) return;

      try {
        const response = await fetch(`${API_URL}/admin/bulk-partylist`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ partylists: candidatesData })
        });

        const result = await response.json();

        if (response.ok) {
          alert(`‚úÖ Uploaded ${result.success_count} partylist(s)!`);
          document.getElementById('candidatesPreview').style.display = 'none';
          document.getElementById('candidatesFile').value = '';
          candidatesData = [];
        } else {
          alert('‚ùå ' + (result.error || 'Upload failed'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Connection error');
      }
    }

    function handleVotersFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        votersData = XLSX.utils.sheet_to_json(sheet);

        displayVotersPreview(votersData);
      };
      reader.readAsArrayBuffer(file);
    }

    function displayVotersPreview(data) {
      const preview = document.getElementById('votersPreview');
      const content = document.getElementById('votersPreviewContent');
      
      content.innerHTML = `
        <p><strong>${data.length} voter(s) found</strong></p>
        <table class="preview-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Student ID</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody>
            ${data.slice(0, 5).map(v => `
              <tr>
                <td>${v['First Name']} ${v['Last Name']}</td>
                <td>${v['Student ID']}</td>
                <td>${v['Student Email']}</td>
              </tr>
            `).join('')}
            ${data.length > 5 ? `<tr><td colspan="3">... and ${data.length - 5} more</td></tr>` : ''}
          </tbody>
        </table>
      `;
      
      preview.style.display = 'block';
    }

    async function uploadVoters() {
      if (!votersData.length) return;

      const formatted = votersData.map(v => ({
        student_id: v['Student ID'],
        email: v['Student Email'],
        password: v['Student ID'],
        full_name: `${v['First Name']} ${v['Middle Name']} ${v['Last Name']}`,
        department: v['Department'],
        year_level: parseInt(v['Year Level'])
      }));

      try {
        const response = await fetch(`${API_URL}/admin/bulk-register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ users: formatted })
        });

        const result = await response.json();

        if (response.ok) {
          alert(`‚úÖ Uploaded ${result.success_count} voter(s)!`);
          document.getElementById('votersPreview').style.display = 'none';
          document.getElementById('votersFile').value = '';
          votersData = [];
          loadVotingStatus();
        } else {
          alert('‚ùå ' + (result.error || 'Upload failed'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Connection error');
      }
    }

    // Load Results
    async function loadResults() {
      try {
        const response = await fetch(`${API_URL}/admin/results/detailed`, {
          credentials: 'include'
        });
        const results = await response.json();

        displayResults(results);
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('resultsContainer').innerHTML = '<p class="error">Failed to load results</p>';
      }
    }

    function displayResults(results) {
      const container = document.getElementById('resultsContainer');
      
      const grouped = results.reduce((acc, r) => {
        if (!acc[r.position_name]) acc[r.position_name] = [];
        acc[r.position_name].push(r);
        return acc;
      }, {});

      container.innerHTML = Object.entries(grouped).map(([position, candidates]) => `
        <div class="result-group">
          <h4>${position}</h4>
          <div class="result-items">
            ${candidates.map((c, idx) => `
              <div class="result-row ${idx === 0 ? 'winner' : ''}">
                <div class="result-info">
                  <span class="rank">${idx + 1}</span>
                  <span class="name">${c.full_name}</span>
                  <span class="dept">${c.department || 'N/A'}</span>
                </div>
                <div class="result-stats">
                  <span class="votes">${c.vote_count || 0} votes</span>
                  <span class="percent">${(c.vote_percentage || 0).toFixed(1)}%</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // Load Voting Status
    async function loadVotingStatus() {
      try {
        const [turnoutRes, resultsRes] = await Promise.all([
          fetch(`${API_URL}/turnout`),
          fetch(`${API_URL}/admin/results/detailed`, { credentials: 'include' })
        ]);

        const turnout = await turnoutRes.json();
        const results = await resultsRes.json();

        document.getElementById('totalVoters').textContent = turnout.total_students || 0;
        document.getElementById('votesCast').textContent = turnout.voted_count || 0;
        document.getElementById('turnout').textContent = (turnout.turnout_percentage || 0) + '%';

        displayPositionBreakdown(results);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function displayPositionBreakdown(results) {
      const container = document.getElementById('positionBreakdown');
      
      const grouped = results.reduce((acc, r) => {
        if (!acc[r.position_name]) acc[r.position_name] = 0;
        acc[r.position_name] += r.vote_count || 0;
        return acc;
      }, {});

      container.innerHTML = Object.entries(grouped).map(([position, count]) => `
        <div class="breakdown-item">
          <span class="breakdown-label">${position}</span>
          <span class="breakdown-value">${count} votes</span>
        </div>
      `).join('');
    }

    // Download Templates
    function downloadCandidateTemplate() {
      const template = [{
        'Name of Partylist': 'Unity Party',
        'Slogan': 'Together We Rise',
        'President': 'John Doe',
        'Vice President Internal': 'Jane Smith',
        'Vice President External': 'Bob Johnson',
        'Secretary': 'Alice Williams',
        'Assistant Secretary': 'Charlie Brown',
        'Treasurer': 'Diana Prince',
        'Auditor': 'Edward Norton',
        'PIO 1': 'Fiona Green',
        'PIO 2': 'George White',
        'Department Representative': 'Hannah Black'
      }];

      const ws = XLSX.utils.json_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Candidates');
      XLSX.writeFile(wb, 'candidates_template.xlsx');
    }

    function downloadVoterTemplate() {
      const template = [{
        'First Name': 'John',
        'Middle Name': 'A.',
        'Last Name': 'Doe',
        'Student ID': '2024-001',
        'Student Email': 'john.doe@school.edu',
        'Department': 'Computer Science',
        'Year Level': 3
      }];

      const ws = XLSX.utils.json_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Voters');
      XLSX.writeFile(wb, 'voters_template.xlsx');
    }

    // Utilities
    function formatDateForInput(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toISOString().slice(0, 16);
    }

    // Logout
    document.getElementById('logout-btn').addEventListener('click', function() {
      if (confirm('Logout from admin panel?')) {
        localStorage.removeItem('admin');
        window.location.href = '/login';
      }
    });
  </script>
</body>
</html>